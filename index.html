<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>GaraÅ¼</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; text-align:center; }
.hidden { display:none !important; }
.center { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; }
video { width:50%; max-width:420px; border-radius:12px; }
#qr-reader { width:300px; margin-top:15px; border-radius:10px; }
input, button { padding:12px; font-size:18px; margin:8px; }
button { user-select:none; cursor:pointer; }
#settingsBtn { position: absolute; top:10px; right:10px; padding:10px 15px; font-size:16px; background:#222; color:white; border:none; border-radius:6px; }
#settingsPanel { position:absolute; top:50px; right:10px; background:#222; padding:20px; border-radius:10px; display:none; width:280px; z-index:10; }
#settingsPanel input { width:90%; }
</style>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<!-- PRZYCISK USTAWIENIA -->
<button id="settingsBtn">âš™ Ustawienia</button>
<div id="settingsPanel">
    <h3>Ustawienia</h3>
    <label>ImiÄ™:</label><br>
    <input id="settingsName" type="text"><br>
    <label>Kod garaÅ¼u:</label><br>
    <input id="settingsCode" type="text"><br>
    <button onclick="saveSettings()">Zapisz</button><br>
    <button onclick="resetSettings()">Resetuj ustawienia</button>
</div>

<!-- 1ï¸âƒ£ KOD / QR -->
<div id="codeScreen" class="center">
    <h2>Podaj kod dostÄ™pu</h2>
    <input id="codeInput" placeholder="Kod">
    <button onclick="saveCode()">Zapisz kod</button>
    <h3>lub zeskanuj QR</h3>
    <div id="qr-reader"></div>
    <button onclick="switchCamera()">OdwrÃ³Ä‡ kamerÄ™</button>
</div>

<!-- 2ï¸âƒ£ WIDEO -->
<div id="videoScreen" class="center hidden">
    <video id="introVideo" autoplay muted playsinline>
        <source src="logo.mp4" type="video/mp4">
    </video>
</div>

<!-- 3ï¸âƒ£ IMIÄ˜ -->
<div id="nameScreen" class="center hidden">
    <h2>Podaj swoje imiÄ™</h2>
    <input id="nameInput" placeholder="ImiÄ™">
    <button onclick="saveName()">Zapisz</button>
</div>

<!-- 4ï¸âƒ£ GÅÃ“WNY -->
<div id="mainScreen" class="center hidden">
    <h1 id="greeting"></h1>
    <button id="openBtn">ðŸšª OtwÃ³rz garaÅ¼</button>
</div>

<script>
const codeScreen  = document.getElementById("codeScreen");
const videoScreen = document.getElementById("videoScreen");
const nameScreen  = document.getElementById("nameScreen");
const mainScreen  = document.getElementById("mainScreen");
const video       = document.getElementById("introVideo");
const greeting    = document.getElementById("greeting");
const openBtn     = document.getElementById("openBtn");

const settingsBtn    = document.getElementById("settingsBtn");
const settingsPanel  = document.getElementById("settingsPanel");
const settingsName   = document.getElementById("settingsName");
const settingsCode   = document.getElementById("settingsCode");

let html5QrCode;
let cameras = [];
let currentCameraIndex = 0;

// ===== START =====
if (!localStorage.getItem("garageCode")) {
    startQR(); 
} else if (!localStorage.getItem("userName")) {
    codeScreen.classList.add("hidden");
    startVideo();
} else {
    codeScreen.classList.add("hidden");
    showMain();
}

// ===== ZAPIS KODU =====
function saveCode(val) {
    val = val || document.getElementById("codeInput").value.trim();
    if (!val) return;
    localStorage.setItem("garageCode", val);
    stopQR();
    codeScreen.classList.add("hidden");
    startVideo();
}

// ===== WIDEO =====
function startVideo() {
    videoScreen.classList.remove("hidden");
    video.playbackRate = 4;
    video.onended = () => {
        videoScreen.classList.add("hidden");
        nameScreen.classList.remove("hidden");
    };
}

// ===== IMIÄ˜ =====
function saveName() {
    const val = document.getElementById("nameInput").value.trim();
    if (!val) return;
    localStorage.setItem("userName", val);
    nameScreen.classList.add("hidden");
    showMain();
}

// ===== EKRAN GÅÃ“WNY =====
function showMain() {
    greeting.innerText = "DzieÅ„ dobry, " + localStorage.getItem("userName");
    mainScreen.classList.remove("hidden");
}

// ===== GARAÅ» =====
function openGarage() {
    const token = localStorage.getItem("garageCode");
    const urlOn = `https://fra1.blynk.cloud/external/api/update?token=${token}&v0=1`;
    const urlOff = `https://fra1.blynk.cloud/external/api/update?token=${token}&v0=0`;

    fetch(urlOn);
    setTimeout(() => fetch(urlOff), 1000);
}

// ===== QR SCAN =====
function startQR() {
    html5QrCode = new Html5Qrcode("qr-reader");
    const qrCodeSuccessCallback = (decodedText) => {
        saveCode(decodedText);
        html5QrCode.stop().catch(err => console.log(err));
    };

    Html5Qrcode.getCameras().then(camList => {
        cameras = camList;
        currentCameraIndex = 0;
        startCamera(cameras[currentCameraIndex].id);
    }).catch(err => {
        alert("BÅ‚Ä…d inicjalizacji kamery: " + err);
    });
}

function startCamera(cameraId) {
    html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        decodedText => saveCode(decodedText)
    ).catch(err => console.log(err));
}

// ===== PRZEÅÄ„CZANIE KAMERY =====
function switchCamera() {
    if (!cameras.length) return;
    html5QrCode.stop().then(() => {
        currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
        startCamera(cameras[currentCameraIndex].id);
    }).catch(err => console.log(err));
}

// ===== USTAWIENIA =====
settingsBtn.addEventListener('click', () => {
    settingsName.value = localStorage.getItem("userName") || "";
    settingsCode.value = localStorage.getItem("garageCode") || "";
    settingsPanel.style.display = settingsPanel.style.display === "none" ? "block" : "none";
});

function saveSettings() {
    const newName = settingsName.value.trim();
    const newCode = settingsCode.value.trim();
    if (newName) localStorage.setItem("userName", newName);
    if (newCode) localStorage.setItem("garageCode", newCode);
    settingsPanel.style.display = "none";
    showMain();
}

function resetSettings() {
    if (confirm("Czy na pewno chcesz zresetowaÄ‡ wszystkie ustawienia?")) {
        localStorage.clear();
        location.reload();
    }
}

// ===== REJESTRACJA SERVICE WORKER =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js').then(function(registration) {
            console.log('Service Worker zarejestrowany:', registration);
        }).catch(function(err) {
            console.log('BÅ‚Ä…d rejestracji Service Workera:', err);
        });
    });
}
</script>
</body>
</html>
