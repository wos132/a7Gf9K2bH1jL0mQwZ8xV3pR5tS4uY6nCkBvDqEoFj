<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>SGS Gara≈º</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  body {
    margin:0;
    font-family:Arial,sans-serif;
    background:#111;
    color:white;
    text-align:center;
  }
  .hidden { display:none !important; }
  .center {
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  #qr-reader {
    width:300px;
    margin-top:15px;
    border-radius:10px;
  }
  input, button {
    padding:12px;
    font-size:18px;
    margin:8px;
  }
  button {
    user-select:none;
    cursor:pointer;
    background:#333;
    color:white;
    border:none;
    border-radius:6px;
  }
  button:hover {
    background:#555;
  }
  #settingsBtn {
    position: absolute;
    top:10px;
    right:10px;
    padding:10px 15px;
    font-size:16px;
  }
  #settingsPanel {
    position:absolute;
    top:50px;
    right:10px;
    background:#222;
    padding:20px;
    border-radius:10px;
    display:none;
    width:280px;
    z-index:10;
  }
  #settingsPanel input {
    width:90%;
  }
  #animationScreen {
    font-size:24px;
    line-height:1.5;
  }
  #animationScreen div {
    margin:20px 0;
  }
</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
<!-- PRZYCISK USTAWIENIA -->
<button id="settingsBtn">‚öô Ustawienia</button>
<div id="settingsPanel">
  <h3>Ustawienia</h3>
  <label>Imiƒô:</label><br>
  <input id="settingsName" type="text"><br>
  <label>Kod dostƒôpu:</label><br>
  <input id="settingsCode" type="text"><br>
  <button onclick="saveSettings()">Zapisz</button><br>
  <button onclick="resetSettings()">Resetuj ustawienia</button>
</div>

<!-- 1Ô∏è‚É£ KOD / QR -->
<div id="codeScreen" class="center">
  <h2>Podaj kod dostƒôpu SGS</h2>
  <input id="codeInput" placeholder="Kod dostƒôpu">
  <button onclick="saveCode()">Zapisz kod</button>
  <h3>lub zeskanuj QR</h3>
  <div id="qr-reader"></div>
  <button onclick="switchCamera()">Odwr√≥ƒá kamerƒô</button>
</div>

<!-- 2Ô∏è‚É£ ANIMACJA -->
<div id="animationScreen" class="center hidden">
  <div id="animationText">≈Åadowanie...</div>
</div>

<!-- 3Ô∏è‚É£ IMIƒò -->
<div id="nameScreen" class="center hidden">
  <h2>Podaj swoje imiƒô</h2>
  <input id="nameInput" placeholder="Imiƒô">
  <button onclick="saveName()">Zapisz</button>
</div>

<!-- 4Ô∏è‚É£ G≈Å√ìWNY -->
<div id="mainScreen" class="center hidden">
  <h1 id="greeting"></h1>
  <button id="openBtn" onclick="openGarage()">üö™ Otw√≥rz gara≈º SGS</button>
</div>

<script>
  const codeScreen = document.getElementById("codeScreen");
  const animationScreen = document.getElementById("animationScreen");
  const nameScreen = document.getElementById("nameScreen");
  const mainScreen = document.getElementById("mainScreen");
  const codeInput = document.getElementById("codeInput");
  const greeting = document.getElementById("greeting");
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsPanel = document.getElementById("settingsPanel");
  const settingsName = document.getElementById("settingsName");
  const settingsCode = document.getElementById("settingsCode");
  let html5QrCode;
  let cameras = [];
  let currentCameraIndex = 0;

  // ===== START =====
  function init() {
    const code = localStorage.getItem("sgsCode");
    const name = localStorage.getItem("userName");
    if (!code) {
      startQR();
    } else if (!name) {
      codeScreen.classList.add("hidden");
      showNameScreen();
    } else {
      codeScreen.classList.add("hidden");
      nameScreen.classList.add("hidden");
      showMain();
    }
  }

  // ===== ZAPIS KODU =====
  function saveCode(val) {
    val = val || codeInput.value.trim();
    if (!val) return;
    localStorage.setItem("sgsCode", val);
    codeInput.value = val;
    stopQR();
    startAnimation();
  }

  // ===== ANIMACJA =====
  function startAnimation() {
    codeScreen.classList.add("hidden");
    animationScreen.classList.remove("hidden");
    const animationText = document.getElementById("animationText");
    
    const steps = [
      { text: "PROSZƒò CZEKAƒÜ", delay: 2000 },
      { text: "≈ÅƒÑCZENIE Z SGS", delay: 2000 },
      { text: "WERYFIKACJA ADRESU IP", delay: 5000 },
      { text: "WERYFIKACJA ADRESU MAC", delay: 2000 },
      { text: "UZYSKIWANIE KODU DOSTƒòPU", delay: 8000 },
      { text: "UZYSKANO DOSTƒòP", delay: 1500 },
      { text: "WITAM W SGS", delay: 2000 }
    ];

    let stepIndex = 0;
    function showNextStep() {
      if (stepIndex < steps.length) {
        animationText.innerText = steps[stepIndex].text;
        setTimeout(showNextStep, steps[stepIndex].delay);
        stepIndex++;
      } else {
        // Po animacji poka≈º ekran imienia
        animationScreen.classList.add("hidden");
        showNameScreen();
      }
    }
    showNextStep();
  }

  // ===== IMIƒò =====
  function showNameScreen() {
    nameScreen.classList.remove("hidden");
  }

  function saveName() {
    const val = document.getElementById("nameInput").value.trim();
    if (!val) return;
    localStorage.setItem("userName", val);
    nameScreen.classList.add("hidden");
    showMain();
  }

  // ===== EKRAN G≈Å√ìWNY =====
  function showMain() {
    greeting.innerText = "Dzie≈Ñ dobry, " + localStorage.getItem("userName");
    mainScreen.classList.remove("hidden");
  }

  // ===== GARA≈ª =====
  function openGarage() {
    const token = localStorage.getItem("sgsCode");
    const urlOn = `https://fra1.blynk.cloud/external/api/update?token=${token}&v0=1`;
    const urlOff = `https://fra1.blynk.cloud/external/api/update?token=${token}&v0=0`;
    const imgOn = new Image();
    imgOn.src = urlOn;
    setTimeout(() => {
      const imgOff = new Image();
      imgOff.src = urlOff;
    }, 1000);
  }

  // ===== QR SCAN =====
  function startQR() {
    html5QrCode = new Html5Qrcode("qr-reader");
    Html5Qrcode.getCameras()
      .then(camList => {
        cameras = camList;
        if (cameras.length > 0) {
          currentCameraIndex = 0;
          startCamera(cameras[currentCameraIndex].id);
        } else {
          alert("Nie znaleziono kamer.");
        }
      })
      .catch(err => alert("B≈ÇƒÖd inicjalizacji kamery: " + err));
  }

  function startCamera(cameraId) {
    html5QrCode.start(
      cameraId,
      { fps: 10, qrbox: 250 },
      decodedText => {
        codeInput.value = decodedText;
        saveCode(decodedText);
      }
    ).catch(err => console.log(err));
  }

  function stopQR() {
    if (html5QrCode) {
      html5QrCode.stop().catch(err => console.log(err));
    }
  }

  // ===== PRZE≈ÅƒÑCZANIE KAMERY =====
  function switchCamera() {
    if (!cameras.length) return;
    html5QrCode.stop().then(() => {
      currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
      startCamera(cameras[currentCameraIndex].id);
    }).catch(err => console.log(err));
  }

  // ===== USTAWIENIA =====
  settingsBtn.addEventListener('click', () => {
    settingsName.value = localStorage.getItem("userName") || "";
    settingsCode.value = localStorage.getItem("sgsCode") || "";
    settingsPanel.style.display = settingsPanel.style.display === "none" ? "block" : "none";
  });

  function saveSettings() {
    const newName = settingsName.value.trim();
    const newCode = settingsCode.value.trim();
    if (newName) localStorage.setItem("userName", newName);
    if (newCode) localStorage.setItem("sgsCode", newCode);
    settingsPanel.style.display = "none";
    if (newName || newCode) {
      showMain();
    }
  }

  function resetSettings() {
    if (confirm("Czy na pewno chcesz zresetowaƒá wszystkie ustawienia?")) {
      localStorage.clear();
      location.reload();
    }
  }

  // ===== SERVICE WORKER =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js')
        .then(registration => console.log('Service Worker zarejestrowany:', registration))
        .catch(err => console.log('B≈ÇƒÖd rejestracji Service Workera:', err));
    });
  }

  // ===== AUTO OD≈öWIE≈ªANIE PO ZMIANIE localStorage =====
  window.addEventListener('storage', event => {
    if (event.key === 'sgsCode' || event.key === 'userName') {
      location.reload();
    }
  });

  // ===== INICJALIZACJA =====
  init();
</script>
</body>
</html>

