<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>GaraÅ¼</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; text-align:center;}
.hidden {display:none !important;}
.center {display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh;}
video {width:50%; max-width:420px; border-radius:12px;}
#qr-reader {width:300px; margin-top:15px; border-radius:10px;}
input,button {padding:12px; font-size:18px; margin:8px;}
</style>

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<!-- 1ï¸âƒ£ KOD / QR -->
<div id="codeScreen" class="center">
    <h2>Podaj kod dostÄ™pu</h2>
    <input id="codeInput" placeholder="Kod">
    <button onclick="saveCode()">Zapisz kod</button>
    <h3>lub zeskanuj QR</h3>
    <div id="qr-reader"></div>
</div>

<!-- 2ï¸âƒ£ WIDEO -->
<div id="videoScreen" class="center hidden">
    <video id="introVideo" autoplay muted playsinline>
        <source src="logo.mp4" type="video/mp4">
    </video>
</div>

<!-- 3ï¸âƒ£ IMIÄ˜ -->
<div id="nameScreen" class="center hidden">
    <h2>Podaj swoje imiÄ™</h2>
    <input id="nameInput" placeholder="ImiÄ™">
    <button onclick="saveName()">Zapisz</button>
</div>

<!-- 4ï¸âƒ£ GÅÃ“WNY -->
<div id="mainScreen" class="center hidden">
    <h1 id="greeting"></h1>
    <button onclick="openGarage()">ðŸšª OtwÃ³rz garaÅ¼</button>
</div>

<script>
const codeScreen  = document.getElementById("codeScreen");
const videoScreen = document.getElementById("videoScreen");
const nameScreen  = document.getElementById("nameScreen");
const mainScreen  = document.getElementById("mainScreen");
const video       = document.getElementById("introVideo");
const greeting    = document.getElementById("greeting");

let html5QrCode;

// **START: zawsze pokazujemy ekran kodu, jeÅ›li brak w localStorage**
if (!localStorage.getItem("garageCode")) {
    startQR(); // start skanera QR
} else if (!localStorage.getItem("userName")) {
    codeScreen.classList.add("hidden");
    startVideo();
} else {
    codeScreen.classList.add("hidden");
    showMain();
}

// ZAPIS KODU
function saveCode(val) {
    val = val || document.getElementById("codeInput").value.trim();
    if (!val) return;

    localStorage.setItem("garageCode", val);
    stopQR();
    codeScreen.classList.add("hidden");
    startVideo();
}

// WIDEO
function startVideo() {
    videoScreen.classList.remove("hidden");
    video.playbackRate = 4;
    video.onended = () => {
        videoScreen.classList.add("hidden");
        nameScreen.classList.remove("hidden");
    };
}

// IMIÄ˜
function saveName() {
    const val = document.getElementById("nameInput").value.trim();
    if (!val) return;

    localStorage.setItem("userName", val);
    nameScreen.classList.add("hidden");
    showMain();
}

// EKRAN GÅÃ“WNY
function showMain() {
    greeting.innerText = "DzieÅ„ dobry, " + localStorage.getItem("userName");
    mainScreen.classList.remove("hidden");
}

// GARAÅ»
function openGarage() {
    const token = localStorage.getItem("garageCode");
    const urlOn = `https://fra1.blynk.cloud/external/api/update?token=${token}&v0=1`;
    const urlOff = `https://fra1.blynk.cloud/external/api/update?token=${token}&v0=0`;

    fetch(urlOn);
    setTimeout(() => fetch(urlOff), 1000);
}

// ===== QR SCAN =====
function startQR() {
    html5QrCode = new Html5Qrcode("qr-reader");
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        saveCode(decodedText);
        html5QrCode.stop().catch(err => console.log(err));
    };

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
            const cameraId = cameras[0].id;
            html5QrCode.start(
                cameraId,
                { fps: 10, qrbox: 250 },
                qrCodeSuccessCallback
            );
        } else {
            alert("Nie znaleziono kamery");
        }
    }).catch(err => {
        alert("BÅ‚Ä…d inicjalizacji kamery: " + err);
    });
}

function stopQR() {
    if (html5QrCode) {
        html5QrCode.stop().catch(err => console.log(err));
    }
}
</script>
</body>
</html>
